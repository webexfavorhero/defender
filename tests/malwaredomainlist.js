var debug = require('debug')('test:malwaredomainlist');

require('../td_common/libs/config');
// connect to DB
// var db = require('../td_common/libs/db');
// db.connectToDb();

// var User = require('../models/user');
// var UrlStatus = require('../models/urlstatus');

var request = require('request');
var csvStream = require('csv-stream');

function check (callback) {

  var csvOptions = {
      delimiter : ',',
      endLine : '\n',
      columns : [
        'dateUtc',
        'urlWithoutProto',
        'ip',
        'reverseLookup',
        'description',
        'registrant',
        'asn',
        'field1',
        'countryCode',
        'field2',
      ],
      escapeChar : '"',
      enclosedChar : '"'
  };

  var csv = csvStream.createStream(csvOptions);
  request({
    url: 'http://www.malwaredomainlist.com/mdlcsv.php',
    // headers: {
    //   'User-Agent': 'request'
    // }
  }).pipe(csv)
    .on('error',function(err) {
      debug('err: ' + err);
    })
    .on('data',function(record) {
      if (record.dateUtc) {
        var url;
        if (record.urlWithoutProto !== '-') {
          url = 'http://' + record.urlWithoutProto;
        } else {
          url = 'http://' + record.ip.replace(/\.$/, '');
                                        // remove '.' if last character is '.'
        }
        debug('url: ', url);
        debug('record: ', JSON.stringify(record));
      }
    })
    .on('end', function () {
      debug('end');
    });
}
check(function() {
  debug('check finish');
});

